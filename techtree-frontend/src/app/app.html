<header class="app-header">
  <div class="header-inner">
    <div class="left-area">
      <div class="logo">Techtree</div>
      <div class="toolbar">
        <button class="btn" (click)="fit()">Fit</button>
        <button class="btn" (click)="zoomIn()">＋</button>
        <button class="btn" (click)="zoomOut()">－</button>
        <button class="btn" (click)="switchLayout()">Layout</button>
        <button class="btn" (click)="toggleSidebar()" title="Toggle details">≡</button>
        <button class="btn" (click)="toggleViewMode()">
          {{ viewMode === 'graph' ? '表表示に切替' : 'ツリー表示に切替' }}
        </button>
        <button
          class="btn"
          [class.active]="editingMode"
          [disabled]="viewMode === 'table'"
          (click)="toggleEditingMode()"
          title="グラフ編集（ノード移動・追加・削除・カテゴリ色変更）を有効化"
        >
          編集モード
        </button>
        <button class="btn" *ngIf="viewMode === 'table'" (click)="downloadCsv()">CSV</button>
        <button class="btn" *ngIf="viewMode === 'graph'" (click)="downloadPng()">PNG</button>
      </div>
      <div class="edit-mode-helper" *ngIf="viewMode === 'graph'">
        <span class="edit-pill" [class.on]="editingMode">{{ editingMode ? '編集ON' : '編集OFF' }}</span>
        <span class="edit-hint" *ngIf="editingMode">
          ノードをドラッグで配置調整しつつ、下のフォームで追加 / 説明変更 / 削除ができます。
        </span>
        <span class="edit-hint" *ngIf="!editingMode">編集が必要なときだけONにしてください。</span>
      </div>
    </div>

    <div class="search-container">
      <div class="search-controls">
        <input type="text" placeholder="検索..." aria-label="search" (input)="applySearch($any($event.target).value)" />

        <div class="filters">
          <div class="filter dropdown" [class.open]="levelMenuOpen">
            <button class="btn filter-trigger" type="button" (click)="toggleLevelMenu()">
              レベル ({{ levelSelectionLabel }})
            </button>
            <div class="filter-menu" *ngIf="levelMenuOpen">
              <label *ngFor="let l of levelOptions" class="checkbox-row">
                <input
                  type="checkbox"
                  [checked]="selectedLevels.has(l)"
                  (change)="toggleLevelSelection(l, $any($event.target).checked)"
                />
                <span>Lv.{{ l }}</span>
              </label>
            </div>
          </div>

          <div class="filter dropdown" [class.open]="categoryMenuOpen">
            <button class="btn filter-trigger" type="button" (click)="toggleCategoryMenu()">
              カテゴリ ({{ categorySelectionLabel }})
            </button>
            <div class="filter-menu" *ngIf="categoryMenuOpen">
              <label *ngFor="let c of categoryOptions" class="checkbox-row">
                <input
                  type="checkbox"
                  [checked]="selectedCategories.has(c)"
                  (change)="toggleCategorySelection(c, $any($event.target).checked)"
                />
                <span>{{ c }}</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="app-body">
  <aside class="details" [class.collapsed]="sidebarCollapsed" id="details">
    <div class="details-header">
      <strong>Details</strong>
    </div>

    <div class="details-body">
      <ng-container *ngIf="selectedNode; else emptyDetails">
        <div class="detail-row"><strong>Label:</strong> {{ selectedNode?.label }}</div>
        <div class="detail-row"><strong>Category:</strong> {{ selectedNode?.category }}</div>

        <div class="detail-row description-row">
          <strong>Description:</strong>
          <p class="description-text">{{ selectedNode?.description || '説明が登録されていません。' }}</p>
        </div>

        <!-- replaced static Level display with editable UI -->
        <div class="detail-row">
          <strong>Level:</strong>
          <div class="level-controls">
            <button class="btn small" (click)="decrementLevel()" title="Decrease">－</button>
            <input type="number" [value]="selectedLevel" (input)="onLevelInput($event.target.value)" min="0" max="5" />
            <button class="btn small" (click)="incrementLevel()" title="Increase">＋</button>
          </div>
          <div class="save-message" *ngIf="saveMessage" [class.error]="saveError">{{ saveMessage }}</div>
        </div>

        <div class="detail-row comment-row">
          <strong>Comment:</strong>
          <textarea
            [(ngModel)]="editedComment"
            rows="4"
            placeholder="コメントを入力してください"
            (blur)="onCommentBlur()"
          ></textarea>
        </div>
      </ng-container>

      <ng-template #emptyDetails>
        <div class="empty">Select a node to view details</div>
      </ng-template>
    </div>
  </aside>

  <main class="main-area">
    <div class="editor-panel" *ngIf="viewMode === 'graph' && editingMode">
      <div class="editor-card info-card">
        <h3>編集モードの使い方</h3>
        <ol class="edit-steps">
          <li><strong>ノードをクリック</strong>して詳細を開きます。位置はドラッグで調整できます（表示のみ）。</li>
          <li>新しいノードを作る場合は「ノード追加」で必要に応じて <strong>親ノード名</strong> を入力して保存します。</li>
          <li>選択中ノードは説明を上書き保存できます。不要なら「ノードを削除」を押してください。</li>
          <li>カテゴリ名と色を入力して「カテゴリ色を保存」を押すと、グラフ全体に即時反映されます。</li>
        </ol>
      </div>
      <div class="editor-card">
        <h3>ノード追加</h3>
        <div class="form-row">
          <label>名前</label>
          <input type="text" [(ngModel)]="newSkill.name" placeholder="スキル名" />
        </div>
        <div class="form-row">
          <label>カテゴリ</label>
          <input type="text" [(ngModel)]="newSkill.category" placeholder="カテゴリ" list="category-options-list" />
        </div>
        <div class="form-row">
          <label>レベル(0-5)</label>
          <input type="number" min="0" max="5" [(ngModel)]="newSkill.level" />
        </div>
        <div class="form-row">
          <label>親ノード(任意)</label>
          <input
            type="text"
            [(ngModel)]="newSkill.parentName"
            placeholder="親ノード名"
            list="skill-name-options-list"
          />
          <small class="hint">入力すると候補が表示されます。未入力の場合は親なしで作成します。</small>
        </div>
        <div class="form-row">
          <label>説明</label>
          <textarea rows="2" [(ngModel)]="newSkill.description"></textarea>
        </div>
        <div class="form-message error" *ngIf="newSkillError">{{ newSkillError }}</div>
        <div class="form-message success" *ngIf="newSkillNotice">{{ newSkillNotice }}</div>
        <button class="btn primary" (click)="createSkill()">ノードを追加</button>
      </div>

      <div class="editor-card">
        <h3>選択中ノード編集</h3>
        <p class="hint" *ngIf="!selectedNode">ノードを選択してください。</p>
        <div *ngIf="selectedNode">
          <div class="form-row">
            <label>カテゴリ</label>
            <input
              type="text"
              [(ngModel)]="selectedCategoryName"
              placeholder="カテゴリ"
              list="category-options-list"
            />
          </div>
          <div class="form-row">
            <label>親ノード(任意)</label>
            <input
              type="text"
              [(ngModel)]="selectedParentName"
              placeholder="親ノード名"
              list="skill-name-options-list"
            />
            <small class="hint">入力すると候補が表示されます。</small>
          </div>
          <button class="btn primary" (click)="saveSelectedMetadata()">カテゴリ/親を保存</button>
          <div class="form-message" [class.error]="metadataSaveIsError" *ngIf="metadataSaveMessage">
            {{ metadataSaveMessage }}
          </div>
          <div class="form-row">
            <label>説明</label>
            <textarea rows="4" [(ngModel)]="selectedNode.description"></textarea>
          </div>
          <button class="btn primary" (click)="saveDescription()">説明を保存</button>
          <button class="btn danger" (click)="deleteSelectedSkill()">ノードを削除</button>
        </div>
      </div>

      <div class="editor-card">
        <h3>カテゴリ色編集</h3>
        <div class="form-row">
          <label>カテゴリ名</label>
          <select [(ngModel)]="editingCategory.name" (change)="onEditingCategoryChange($any($event.target).value)">
            <option value="" disabled>カテゴリを選択</option>
            <option *ngFor="let c of categoryOptions" [value]="c">{{ c }}</option>
          </select>
        </div>
        <div class="form-row">
          <label>色</label>
          <input type="color" class="color-circle-input" [(ngModel)]="editingCategory.color" />
        </div>
        <button class="btn primary" (click)="saveCategoryColor()">カテゴリ色を保存</button>
      </div>
    </div>

    <datalist id="category-options-list">
      <option *ngFor="let c of categoryOptions" [value]="c"></option>
    </datalist>
    <datalist id="skill-name-options-list">
      <option *ngFor="let name of skillNameOptions" [value]="name"></option>
    </datalist>

    <!-- cytoscape container -->
    <div id="cy" [class.hidden]="viewMode === 'table'"></div>

    <div class="table-view" *ngIf="viewMode === 'table'">
      <div class="table-inner">
        <table class="skill-table">
          <thead>
            <tr>
              <th (click)="toggleSort('label')">Name <span class="sort-indicator">{{ sortIndicator('label') }}</span></th>
              <th (click)="toggleSort('category')">Category <span class="sort-indicator">{{ sortIndicator('category') }}</span></th>
              <th (click)="toggleSort('level')">Level <span class="sort-indicator">{{ sortIndicator('level') }}</span></th>
              <th (click)="toggleSort('description')">
                Description <span class="sort-indicator">{{ sortIndicator('description') }}</span>
              </th>
              <th (click)="toggleSort('user_comment')">Comment <span class="sort-indicator">{{ sortIndicator('user_comment') }}</span></th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let row of filteredTableRows"
              (click)="selectSkillFromTable(row)"
              [class.active]="selectedNode?.id === 'skill-' + row.id"
            >
              <td>{{ row.name || row.label }}</td>
              <td>{{ row.category }}</td>
              <td class="editable-cell">
                <input
                  type="number"
                  min="0"
                  max="5"
                  [value]="row.level"
                  (blur)="onTableLevelBlur(row, $any($event.target).value)"
                />
              </td>
              <td class="description-cell">{{ row.description || '' }}</td>
              <td class="editable-cell">
                <textarea rows="2" [value]="row.user_comment || ''" (blur)="onTableCommentBlur(row, $any($event.target).value)"></textarea>
              </td>
            </tr>
            <tr *ngIf="!filteredTableRows || filteredTableRows.length === 0">
              <td colspan="5" class="empty-row">該当するデータがありません</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>