<header class="app-header">
  <div class="header-inner">
    <div class="left-area">
      <div class="logo">Techtree</div>
      <div class="toolbar">
        <button class="btn" (click)="fit()">Fit</button>
        <button class="btn" (click)="zoomIn()">＋</button>
        <button class="btn" (click)="zoomOut()">－</button>
        <button class="btn" (click)="switchLayout()">Layout</button>
        <button class="btn" (click)="toggleSidebar()" title="Toggle details">≡</button>
      </div>
    </div>

    <div class="search-container">
      <div class="search-controls">
        <input type="text" placeholder="検索..." aria-label="search" (input)="applySearch($any($event.target).value)" />

        <div class="filters">
          <div class="filter dropdown" [class.open]="levelMenuOpen">
            <button class="btn filter-trigger" type="button" (click)="toggleLevelMenu()">
              レベル ({{ levelSelectionLabel }})
            </button>
            <div class="filter-menu" *ngIf="levelMenuOpen">
              <label *ngFor="let l of levelOptions" class="checkbox-row">
                <input
                  type="checkbox"
                  [checked]="selectedLevels.has(l)"
                  (change)="toggleLevelSelection(l, $any($event.target).checked)"
                />
                <span>Lv.{{ l }}</span>
              </label>
            </div>
          </div>

          <div class="filter dropdown" [class.open]="categoryMenuOpen">
            <button class="btn filter-trigger" type="button" (click)="toggleCategoryMenu()">
              カテゴリ ({{ categorySelectionLabel }})
            </button>
            <div class="filter-menu" *ngIf="categoryMenuOpen">
              <label *ngFor="let c of categoryOptions" class="checkbox-row">
                <input
                  type="checkbox"
                  [checked]="selectedCategories.has(c)"
                  (change)="toggleCategorySelection(c, $any($event.target).checked)"
                />
                <span>{{ c }}</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="app-body">
  <aside class="details" [class.collapsed]="sidebarCollapsed" id="details">
    <div class="details-header">
      <strong>Details</strong>
    </div>

    <div class="details-body">
      <ng-container *ngIf="selectedNode; else emptyDetails">
        <div class="detail-row"><strong>Label:</strong> {{ selectedNode?.label }}</div>
        <div class="detail-row"><strong>Category:</strong> {{ selectedNode?.category }}</div>

        <div class="detail-row description-row">
          <strong>Description:</strong>
          <div class="detail-text">{{ selectedNode?.description || '説明が登録されていません。' }}</div>
        </div>

        <!-- replaced static Level display with editable UI -->
        <div class="detail-row">
          <strong>Level:</strong>
          <div class="level-controls">
            <button class="btn small" (click)="decrementLevel()" title="Decrease">－</button>
            <input type="number" [value]="selectedLevel" (input)="onLevelInput($event.target.value)" min="0" />
            <button class="btn small" (click)="incrementLevel()" title="Increase">＋</button>
            <button class="btn" (click)="saveDetails()"
              [disabled]="isSavingDetails || !hasUnsavedChanges()">Save</button>
          </div>
          <div class="save-message" *ngIf="saveMessage" [class.error]="saveError">{{ saveMessage }}</div>
        </div>

        <div class="detail-row comment-row">
          <div class="comment-header">
            <strong>Comment:</strong>
            <button class="btn small" *ngIf="!isEditingComment" (click)="startCommentEdit()">Edit</button>
            <button class="btn small" *ngIf="isEditingComment" (click)="cancelCommentEdit()">Cancel</button>
          </div>
          <div *ngIf="!isEditingComment" class="comment-display">{{ selectedComment || 'コメントがありません。' }}</div>
          <textarea *ngIf="isEditingComment" [(ngModel)]="editedComment" rows="4" placeholder="コメントを入力してください"></textarea>
        </div>
      </ng-container>

      <ng-template #emptyDetails>
        <div class="empty">Select a node to view details</div>
      </ng-template>
    </div>
  </aside>

  <main class="main-area">
    <!-- cytoscape container -->
    <div id="cy"></div>
  </main>
</div>